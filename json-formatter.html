<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JSON Formatter — Auto Repair</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1.25rem; background:#f8f9fa }
    .editor-area { height: 60vh; resize: none; font-family: monospace; }
    .output-pre { height: 30vh; overflow: auto; background: #fff; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 1rem; }
    .tree { height: 30vh; overflow:auto; background: #fff; border: 1px solid #dee2e6; padding: 1rem; }
    .collapser { cursor: pointer; user-select: none; }
    .key { color: #0d6efd; }
    .string { color: #198754; }
    .number { color: #d63384; }
    .bool { color: #fd7e14; }
    .null { color: #6c757d; }
    .small-muted { font-size: .85rem; color: #6c757d }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="mb-3">JSON Formatter + Auto Repair</h3>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-2 d-flex gap-2 flex-wrap">
              <button id="btnFormat" class="btn btn-primary btn-sm">Format</button>
              <button id="btnMinify" class="btn btn-secondary btn-sm">Minify</button>
              <button id="btnValidate" class="btn btn-outline-success btn-sm">Validate</button>
              <button id="btnRepair" class="btn btn-warning btn-sm">Auto Fix & Format</button>
              <button id="btnClear" class="btn btn-outline-danger btn-sm">Clear</button>
            </div>
            <textarea id="jsonInput" class="form-control editor-area" placeholder='Dán JSON vào đây...'></textarea>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6>Output + Tree view</h6>
            <pre id="prettyOutput" class="output-pre"></pre>
            <div id="treeView" class="tree"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
  const input = document.getElementById('jsonInput');
  const pretty = document.getElementById('prettyOutput');
  const tree = document.getElementById('treeView');

  function showError(msg) {
    pretty.textContent = msg;
    pretty.style.color = 'crimson';
    tree.innerHTML = '';
  }
  function clearErrorStyle() { pretty.style.color = ''; }

  function formatJSON() {
    const text = input.value.trim();
    if (!text) { pretty.textContent = ''; tree.innerHTML = ''; return; }
    try {
      const obj = JSON.parse(text);
      pretty.textContent = JSON.stringify(obj, null, 2);
      clearErrorStyle();
      renderTree(obj);
    } catch (e) { showError('JSON invalid: ' + e.message); }
  }

  function minifyJSON() {
    try {
      const obj = JSON.parse(input.value.trim());
      input.value = JSON.stringify(obj);
      formatJSON();
    } catch (e) { showError('JSON invalid: ' + e.message); }
  }

  function validateJSON() {
    try {
      const obj = JSON.parse(input.value.trim());
      pretty.textContent = 'Valid JSON';
      pretty.style.color = 'green';
      renderTree(obj);
    } catch (e) { showError('Invalid JSON: ' + e.message); }
  }

  function autoRepairJSON(text) {
    return text
      .replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":')
      .replace(/'/g, '"')
      .replace(/,(\s*[}\]])/g, '$1')
      .replace(/\/\*[^*]*\*+(?:[^/*][^*]*\*+)*\//g, '')
      .replace(/\/\/.*$/gm, '');
  }

  function autoFixAndFormat() {
    let fixed = autoRepairJSON(input.value);
    try {
      const obj = JSON.parse(fixed);
      input.value = JSON.stringify(obj, null, 2);
      formatJSON();
    } catch (e) { showError('Không thể sửa hoàn toàn: ' + e.message); }
  }

  function renderTree(obj) {
    tree.innerHTML = '';
    tree.appendChild(createNode(null, obj));
  }

  function createNode(key, value) {
    const wrap = document.createElement('div');
    const type = value === null ? 'null' : Array.isArray(value) ? 'array' : typeof value;
    if (type === 'object' || type === 'array') {
      const header = document.createElement('div');
      const collapser = document.createElement('span');
      collapser.textContent = '-';
      collapser.className = 'collapser me-1 fw-bold';
      const body = document.createElement('div');
      body.style.paddingLeft = '1rem';
      collapser.onclick = () => {
        body.style.display = body.style.display === 'none' ? '' : 'none';
        collapser.textContent = collapser.textContent === '-' ? '+' : '-';
      };
      header.appendChild(collapser);
      if (key !== null) { const k = document.createElement('span'); k.className = 'key'; k.textContent = key + ': '; header.appendChild(k); }
      wrap.appendChild(header);
      const entries = type === 'array' ? value.map((v, i) => [i, v]) : Object.entries(value);
      for (const [k, v] of entries) body.appendChild(createNode(k, v));
      wrap.appendChild(body);
    } else {
      if (key !== null) { const k = document.createElement('span'); k.className = 'key'; k.textContent = key + ': '; wrap.appendChild(k); }
      const val = document.createElement('span');
      if (type === 'string') { val.className = 'string'; val.textContent = '"' + value + '"'; }
      else if (type === 'number') { val.className = 'number'; val.textContent = value; }
      else if (type === 'boolean') { val.className = 'bool'; val.textContent = value; }
      else { val.className = 'null'; val.textContent = 'null'; }
      wrap.appendChild(val);
    }
    return wrap;
  }

  document.getElementById('btnFormat').onclick = formatJSON;
  document.getElementById('btnMinify').onclick = minifyJSON;
  document.getElementById('btnValidate').onclick = validateJSON;
  document.getElementById('btnRepair').onclick = autoFixAndFormat;
  document.getElementById('btnClear').onclick = () => { input.value = ''; pretty.textContent = ''; tree.innerHTML = ''; };
</script>
</body>
</html>
